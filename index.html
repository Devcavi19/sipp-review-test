<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CS4116 SIPP Quiz Reviewer</title>
<style>
  :root { --bg:#0b132b; --panel:#1c2541; --card:#3a506b; --acc:#5bc0be; --text:#eaeaea; --warn:#ffb703; --bad:#ef476f; --good:#06d6a0; }
  body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
  header { padding:12px 16px; background:var(--panel); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; flex:1; min-width:200px; }
  header select, header button { background:var(--card); color:var(--text); border:1px solid #2a3b57; border-radius:8px; padding:8px 10px; font-size:14px; cursor:pointer; }
  header select:hover, header button:hover { border-color:var(--acc); }
  main { display:grid; grid-template-columns: 1fr 320px; gap:16px; padding:16px; }
  .card { background:var(--panel); border:1px solid #2a3b57; border-radius:12px; padding:16px; }
  .q-meta { font-size:12px; opacity:.9; margin-bottom:8px; display:flex; gap:8px; align-items:center; }
  .badge { background:var(--card); padding:2px 8px; border-radius:999px; border:1px solid #2a3b57; }
  .q-text { font-size:18px; margin:6px 0 12px; line-height:1.5; }
  .choices { display:grid; gap:8px; margin:10px 0; }
  .choice { background:var(--card); border:1px solid #2a3b57; padding:10px; border-radius:10px; display:flex; align-items:center; gap:10px; cursor:pointer; transition:all 0.2s; }
  .choice:hover { border-color:var(--acc); background:#475a77; }
  .choice input { transform:scale(1.2); cursor:pointer; }
  .choice span { flex:1; line-height:1.4; }
  .actions { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
  .btn { background:var(--acc); color:#0b132b; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:600; transition:all 0.2s; }
  .btn:hover:not(:disabled) { background:#6dd4d2; transform:translateY(-1px); }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }
  .btn.secondary { background:var(--card); color:var(--text); border:1px solid #2a3b57; }
  .btn.secondary:hover:not(:disabled) { background:#475a77; border-color:var(--acc); }
  .feedback { margin-top:12px; padding:12px; border-radius:10px; border:1px solid #2a3b57; background:#24304d; }
  .correct { color:var(--good); font-weight:600; }
  .incorrect { color:var(--bad); font-weight:600; }
  .scorebar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .pill { padding:4px 8px; border-radius:999px; border:1px solid #2a3b57; background:var(--card); font-size:13px; }
  .weaklist li { margin:4px 0; font-size:13px; }
  .loading { color:var(--warn); font-style:italic; }
  .error { color:var(--bad); padding:12px; border-radius:8px; background:var(--panel); border:1px solid var(--bad); margin:10px 0; }
  footer { padding:12px 16px; opacity:.9; text-align:center; font-size:13px; }
  @media (max-width: 960px) { main { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <h1>CS4116 SIPP Quiz Reviewer</h1>
  <select id="moduleSel">
    <option value="">Select Module...</option>
    <option value="mcq1.json">Module 1 - Ethics & Business Ethics</option>
    <option value="mcq2.json">Module 2 - Professional Codes & IT Ethics</option>
    <option value="mcq3.json">Module 3 - Cybersecurity</option>
    <option value="mcq4.json">Module 4 - Privacy & Freedom</option>
  </select>
  <select id="mode">
    <option value="all">All Questions</option>
    <option value="mc">MC only</option>
    <option value="tf">TF only</option>
  </select>
  <select id="length">
    <option value="10">10 Q</option>
    <option value="15" selected>15 Q</option>
    <option value="20">20 Q</option>
    <option value="30">30 Q</option>
    <option value="40">40 Q</option>
  </select>
  <button id="startBtn" class="btn" disabled>Start Quiz</button>
  <div class="scorebar">
    <span class="pill" id="prog">0/0</span>
    <span class="pill">Score: <span id="score">0</span></span>
    <span class="pill">Streak: <span id="streak">0</span></span>
    <span class="pill">Accuracy: <span id="acc">0%</span></span>
  </div>
</header>

<main>
  <section class="card" id="quizCard">
    <div class="q-meta">
      <span class="badge" id="qType">‚Äî</span>
      <span class="badge" id="qTopic">‚Äî</span>
      <span class="badge" id="qIdx">Q ‚Äî</span>
    </div>
    <div class="q-text" id="qText">Select a module above to begin.</div>
    <div class="choices" id="choices"></div>
    <div class="actions">
      <button class="btn" id="submitBtn" disabled>Submit</button>
      <button class="btn secondary" id="skipBtn" disabled>Skip</button>
      <button class="btn secondary" id="nextBtn" disabled>Next</button>
    </div>
    <div class="feedback" id="feedback" style="display:none;"></div>
  </section>

  <aside class="card">
    <h3>üìä Weak Topics</h3>
    <ol class="weaklist" id="weakList"><li>No data yet. Start a quiz!</li></ol>
    <hr />
    <h3>üìù Session Notes</h3>
    <ul style="padding-left:18px; margin-top:6px; line-height:1.4; font-size:13px;">
      <li>Misses trigger a follow-up from the same topic when available.</li>
      <li>Use MC-only/TF-only to target format weaknesses.</li>
      <li>Explanations are concise and exam-focused.</li>
      <li>Skip moves question to end of queue.</li>
    </ul>
  </aside>
</main>

<footer>
  <p><strong>CS4116 - Social Issues and Professional Practice</strong></p>
  <p>Comprehensive reviewer covering all four modules | Select module ‚Üí Configure quiz ‚Üí Start</p>
</footer>

<script>
/* ============ Quiz State ============ */
const qs = (s) => document.querySelector(s);
const moduleSel = qs('#moduleSel'), modeSel = qs('#mode'), lenSel = qs('#length'), startBtn = qs('#startBtn');
const qType = qs('#qType'), qTopic = qs('#qTopic'), qIdx = qs('#qIdx'), qText = qs('#qText');
const choicesEl = qs('#choices'), submitBtn = qs('#submitBtn'), skipBtn = qs('#skipBtn'), nextBtn = qs('#nextBtn');
const feedback = qs('#feedback'), scoreEl = qs('#score'), progEl = qs('#prog'), streakEl = qs('#streak'), accEl = qs('#acc'), weakList = qs('#weakList');

let BANK = [];
let session = [], ptr = 0, score = 0, streak = 0, answered = false;
let wrongByTopic = new Map(), correctByTopic = new Map(), pendingFollowUp = null;
let currentModule = '';

/* ============ Module Loading ============ */
async function loadModule(filename) {
  try {
    qText.innerHTML = '<span class="loading">Loading module...</span>';
    const response = await fetch(filename);
    if (!response.ok) throw new Error(`Failed to load ${filename}`);
    
    const jsonData = await response.json();
    if (!Array.isArray(jsonData)) throw new Error('Invalid JSON format');
    
    // Convert to internal format
    BANK = jsonData.map(item => {
      const converted = {
        id: item.id,
        type: item.type || 'MC',
        topic: item.topic,
        text: item.question || item.text,
        explanation: item.explanation
      };
      
      if (item.choices && Array.isArray(item.choices)) {
        converted.choices = item.choices;
        converted.answer = typeof item.answer === 'number' ? item.answer : item.choices.indexOf(item.answer);
      } else if (item.type === 'TF') {
        converted.answer = item.answer;
      } else if (item.type === 'SA') {
        converted.answerText = item.answerText || item.answer;
      }
      
      return converted;
    });
    
    currentModule = filename;
    startBtn.disabled = false;
    qText.textContent = `‚úÖ Loaded ${BANK.length} questions. Click "Start Quiz" to begin!`;
    console.log(`‚úÖ Loaded ${BANK.length} questions from ${filename}`);
    
    // Reset stats
    wrongByTopic.clear();
    correctByTopic.clear();
    renderWeak();
    
  } catch (error) {
    console.error('Error loading module:', error);
    qText.innerHTML = `<div class="error">‚ùå Error loading module: ${error.message}<br>Please check that the JSON file exists and is valid.</div>`;
    BANK = [];
    startBtn.disabled = true;
  }
}

moduleSel.addEventListener('change', (e) => {
  const filename = e.target.value;
  if (filename) {
    loadModule(filename);
  } else {
    BANK = [];
    startBtn.disabled = true;
    qText.textContent = 'Select a module above to begin.';
  }
});

/* ============ Quiz Logic ============ */
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function makeSession() {
  if (BANK.length === 0) {
    alert('Please select a module first!');
    return;
  }
  
  const mode = modeSel.value;
  let pool = BANK.filter(q => {
    if (mode === 'all') return true;
    if (mode === 'mc') return q.type === 'MC';
    if (mode === 'tf') return q.type === 'TF';
    return true;
  });
  
  if (pool.length === 0) {
    alert('No questions match the selected filter!');
    return;
  }
  
  pool = shuffle([...pool]);
  const n = parseInt(lenSel.value, 10);
  session = pool.slice(0, Math.min(n, pool.length));
  ptr = 0; score = 0; streak = 0; pendingFollowUp = null;
  updateHud();
}

function updateHud() {
  progEl.textContent = `${Math.min(ptr, session.length)}/${session.length}`;
  scoreEl.textContent = score.toString();
  streakEl.textContent = streak.toString();
  const total = Math.max(1, ptr);
  accEl.textContent = `${Math.round((score / total) * 100)}%`;
  renderWeak();
}

function renderWeak() {
  if (BANK.length === 0) {
    weakList.innerHTML = '<li>No data yet. Load a module first!</li>';
    return;
  }
  
  const topics = new Set([...BANK.map(q => q.topic)]);
  const rows = [];
  topics.forEach(t => {
    const wrong = wrongByTopic.get(t) || 0;
    const correct = correctByTopic.get(t) || 0;
    const total = wrong + correct;
    const acc = total ? Math.round((correct / total) * 100) : 0;
    if (total > 0) rows.push({ t, wrong, acc, total });
  });
  
  if (rows.length === 0) {
    weakList.innerHTML = '<li>No weak topics yet. Start a quiz!</li>';
    return;
  }
  
  rows.sort((a, b) => b.wrong - a.wrong || a.acc - b.acc);
  weakList.innerHTML = rows.slice(0, 7).map(r => 
    `<li><strong>${r.t}</strong><br>Misses: ${r.wrong} | Accuracy: ${r.acc}%</li>`
  ).join('');
}

function renderQuestion() {
  answered = false;
  feedback.style.display = 'none'; 
  feedback.innerHTML = '';
  submitBtn.disabled = true; 
  nextBtn.disabled = true; 
  skipBtn.disabled = false;
  
  const q = session[ptr];
  if (!q) {
    qText.textContent = 'üéâ Quiz Complete! Review weak topics in the sidebar and click "Start Quiz" for a new session.';
    choicesEl.innerHTML = '';
    qType.textContent = '‚Äî';
    qTopic.textContent = '‚Äî';
    qIdx.textContent = `Q ${ptr}/${session.length}`;
    skipBtn.disabled = true;
    submitBtn.disabled = true;
    return;
  }
  
  qType.textContent = q.type;
  qTopic.textContent = q.topic;
  qIdx.textContent = `Q ${ptr + 1}/${session.length}`;
  qText.textContent = q.text;

  choicesEl.innerHTML = '';
  
  if (q.type === 'TF') {
    const opts = ['True', 'False'];
    opts.forEach((label) => {
      const div = document.createElement('label');
      div.className = 'choice';
      div.innerHTML = `<input type="radio" name="ans" value="${label === 'True'}" /> <span>${label}</span>`;
      div.addEventListener('click', () => submitBtn.disabled = false);
      choicesEl.appendChild(div);
    });
  } else if (q.type === 'MC') {
    q.choices.forEach((c, i) => {
      const div = document.createElement('label');
      div.className = 'choice';
      div.innerHTML = `<input type="radio" name="ans" value="${i}" /> <span>${String.fromCharCode(65 + i)}. ${c}</span>`;
      div.addEventListener('click', () => submitBtn.disabled = false);
      choicesEl.appendChild(div);
    });
  } else if (q.type === 'SA') {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    const ta = document.createElement('textarea');
    ta.id = 'sa-input';
    ta.rows = 3;
    ta.style.padding = '10px';
    ta.style.borderRadius = '8px';
    ta.style.border = '1px solid #2a3b57';
    ta.style.background = 'var(--card)';
    ta.style.color = 'var(--text)';
    ta.style.fontFamily = 'inherit';
    ta.placeholder = 'Type your one-sentence answer here...';
    ta.addEventListener('input', () => { submitBtn.disabled = ta.value.trim().length === 0; });
    wrapper.appendChild(ta);
    choicesEl.appendChild(wrapper);
  }
}

function getSelected() {
  const q = session[ptr];
  if (!q) return null;
  if (q.type === 'SA') {
    const ta = document.querySelector('#sa-input');
    if (!ta) return null;
    return ta.value.trim();
  }
  const inp = [...document.querySelectorAll('input[name="ans"]:checked')][0];
  if (!inp) return null;
  return inp.value;
}

function pickFollowUpTopic(topic) {
  const candidates = BANK.filter(q => q.topic === topic);
  const unseen = candidates.filter(q => !session.find(x => x.id === q.id));
  return shuffle(unseen)[0] || shuffle(candidates)[0] || null;
}

function recordTopic(topic, ok) {
  const map = ok ? correctByTopic : wrongByTopic;
  map.set(topic, (map.get(topic) || 0) + 1);
}

/* ============ Event Handlers ============ */
submitBtn.addEventListener('click', () => {
  if (answered) return;
  const q = session[ptr];
  const sel = getSelected();
  if (sel === null) return;
  answered = true;
  skipBtn.disabled = true; 
  submitBtn.disabled = true; 
  nextBtn.disabled = false;

  let correct = false;
  if (q.type === 'TF') { 
    correct = (String(q.answer) === sel); 
  } else if (q.type === 'SA') {
    const expected = (q.answerText || '').trim().toLowerCase();
    const got = (sel || '').trim().toLowerCase();
    correct = expected && (got === expected);
  } else { 
    correct = (q.answer === parseInt(sel, 10)); 
  }

  if (correct) { 
    score++; 
    streak++; 
    recordTopic(q.topic, true); 
  } else { 
    streak = 0; 
    recordTopic(q.topic, false); 
    pendingFollowUp = pickFollowUpTopic(q.topic); 
  }

  updateHud();

  const icon = correct ? '‚úÖ' : '‚ùå';
  const color = correct ? 'correct' : 'incorrect';
  const tip = correct ? '' : `<div style="margin-top:8px; padding:8px; background:#3a2f1f; border-radius:6px; border-left:3px solid var(--warn);"><strong>üí° Tip:</strong> Review the core concept of <em>${q.topic}</em>. A follow-up question will appear next to reinforce this topic.</div>`;
  feedback.style.display = 'block';
  const modelAns = q.type === 'SA' ? `<div style="margin-top:8px;"><strong>Model answer:</strong> ${q.answerText}</div>` : '';
  feedback.innerHTML = `<div class="${color}" style="font-size:16px; margin-bottom:8px;">${icon} ${correct ? 'Correct!' : 'Incorrect'}</div>
    ${modelAns}
    <div style="margin-top:8px;"><strong>Explanation:</strong> ${q.explanation}</div>${tip}`;
});

nextBtn.addEventListener('click', () => {
  if (!answered) return;
  if (pendingFollowUp) {
    session.splice(ptr + 1, 0, pendingFollowUp);
    pendingFollowUp = null;
  }
  ptr++;
  updateHud();
  renderQuestion();
});

skipBtn.addEventListener('click', () => {
  if (answered) return;
  const q = session.splice(ptr, 1)[0];
  session.push(q);
  renderQuestion();
});

startBtn.addEventListener('click', () => {
  makeSession();
  renderQuestion();
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !submitBtn.disabled) {
    submitBtn.click();
  } else if (e.key === 'n' && !nextBtn.disabled) {
    nextBtn.click();
  } else if (e.key === 's' && !skipBtn.disabled) {
    skipBtn.click();
  }
});
</script>
</body>
</html>
